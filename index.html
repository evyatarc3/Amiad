<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול משמרות</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        .daily-total.holiday {
            background-color: #fff59d;
            color: #666;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .controls {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        label {
            font-weight: bold;
            color: #555;
        }
        
        input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        button:hover {
            opacity: 0.8;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-success {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-warning {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stat-box h4 {
            color: #666;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .stat-box .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-box .value.error {
            color: #f44336;
        }
        
        .stat-box .value.warning {
            color: #ff9800;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        th {
            background-color: #2196F3;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .employee-name {
            background-color: #e3f2fd;
            font-weight: bold;
            text-align: right;
            position: sticky;
            right: 0;
            z-index: 5;
            min-width: 150px;
        }
        
        .date-header {
            writing-mode: vertical-lr;
            text-orientation: mixed;
            height: 80px;
            width: 40px;
        }
        
        .shift-cell {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .shift-cell:hover {
            background-color: #f0f0f0;
        }
        
        .shift-cell.checked {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        
        .shift-cell.manual {
            background-color: #2e7d32;
        }
        
        .shift-cell.holiday {
            background-color: #fff59d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .shift-cell.checked.holiday {
            background-color: #689f38;
        }
        
        .total-cell {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .total-cell.error {
            background-color: #ffcdd2;
            color: #d32f2f;
        }
        
        .total-cell.warning {
            background-color: #ffe082;
            color: #f57f17;
        }
        
        .daily-total {
            background-color: #e8f5e9;
            font-weight: bold;
        }
        
        .search-section {
            background-color: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .highlight {
            outline: 3px solid #ff9800;
            outline-offset: -1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>מערכת ניהול משמרות - 17 עובדים</h1>
        
        <div class="controls">
            <h3>הגדרות:</h3>
            <div class="control-row">
                <label>תאריך התחלה:</label>
                <input type="date" id="startDate" value="2024-07-28">
                <label>תאריך סיום:</label>
                <input type="date" id="endDate" value="2024-10-08">
                <button class="btn-primary" onclick="updateDates()">עדכן תאריכים</button>
            <div class="control-row">
                <label>הוסף תקופת חופש:</label>
                <input type="date" id="holidayStart" placeholder="מתאריך">
                <input type="date" id="holidayEnd" placeholder="עד תאריך">
                <button class="btn-warning" onclick="addHolidayPeriod()">הוסף חופש</button>
                <button class="btn-danger" onclick="clearHolidays()">נקה חופשים</button>
            </div>
            <div class="control-row">
                <label>מינימום עובדים ביום:</label>
                <input type="number" id="minWorkers" value="6" min="1" style="width: 60px;" onchange="updateMinWorkers()">
                <label>מקסימום ימי היעדרות:</label>
                <input type="number" id="maxAbsence" value="6" min="1" style="width: 60px;" onchange="updateMaxAbsence()">
            </div>
            <div class="control-row">
                <label>הוסף עובד:</label>
                <input type="text" id="newEmployee" placeholder="שם העובד">
                <button class="btn-success" onclick="addEmployee()">הוסף</button>
                <select id="removeEmployee" style="margin-right: 20px;">
                    <option value="">בחר עובד להסרה...</option>
                </select>
                <button class="btn-danger" onclick="removeEmployee()">הסר</button>
            </div>
        </div>
        
        <div class="search-section">
            <h3>חיפוש:</h3>
            <div class="control-row">
                <input type="text" id="searchName" placeholder="חפש לפי שם..." onkeyup="searchByName()">
                <input type="date" id="searchDate" onchange="searchByDate()">
                <button class="btn-warning" onclick="clearSearch()">נקה חיפוש</button>
            </div>
        </div>
        
        <div class="controls" style="background-color: #fff3e0; margin-bottom: 20px;">
            <h3>תקופות חופש פעילות:</h3>
            <div id="holidaysList">
                <p>4/8/2024 - 16/8/2024 (לא כולל 3/8 ו-17/8)</p>
                <p>1/9/2024 - 13/9/2024 (לא כולל 31/8 ו-14/9)</p>
            </div>
            <p style="color: #666; font-size: 14px;">בימי חופש לא ניתן לשבץ עובדים והם לא נספרים כימי היעדרות</p>
        </div>
        
        <div class="stats-container">
            <div class="stat-box">
                <h4>סה"כ ימים</h4>
                <div class="value" id="totalDays">0</div>
            </div>
            <div class="stat-box">
                <h4>ימי עבודה</h4>
                <div class="value" id="workDays">0</div>
            </div>
            <div class="stat-box" style="background-color: #fff59d;">
                <h4>ימי חופש</h4>
                <div class="value" id="holidayDays" style="color: #f57f17;">0</div>
            </div>
            <div class="stat-box">
                <h4>ימים עם מחסור</h4>
                <div class="value error" id="lowDays">0</div>
            </div>
            <div class="stat-box">
                <h4>ימים עם עודף</h4>
                <div class="value warning" id="highDays">0</div>
            </div>
            <div class="stat-box">
                <h4>היעדרויות ארוכות</h4>
                <div class="value error" id="violations">0</div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn-success" onclick="smartFill()">🎯 השלם חכם</button>
            <button class="btn-warning" onclick="randomFill()">🎲 שיבוץ רנדומלי מלא</button>
            <button class="btn-danger" onclick="clearAll()">🗑️ נקה הכל</button>
            <button class="btn-primary" onclick="validateSchedule()">✔️ בדוק תקינות</button>
            <button class="btn-primary" onclick="exportCSV()">📊 ייצוא CSV</button>
            <button class="btn-primary" onclick="showHelp()">❓ עזרה</button>
        </div>
        
        <div class="table-container">
            <table id="mainTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Initial data
        let employees = [
            "דוד בר-און", "יצחק סיבוני", "מרו מנטאסנוט", "אביתר כהן",
            "שי תמם", "רם שילון", "נדב תורג׳מן", "יגל טויטו",
            "אהרון רטנר", "אהוד לובטון", "דגן", "שרון ברששת",
            "אריאל ליבמן", "רואי אלבז", "שילה פארן", "מתן גרידיש", "יטיב דמרי"
        ];
        
        let shifts = {};
        let startDate = new Date('2024-07-28');
        let endDate = new Date('2024-10-08');
        let minWorkers = 6;
        let maxAbsence = 6;
        
        const holidays = [
            { start: new Date('2024-08-04'), end: new Date('2024-08-16') },
            { start: new Date('2024-09-01'), end: new Date('2024-09-13') }
        ];
        
        // Initialize
        function init() {
            updateHolidaysList();
            buildTable();
            updateStats();
        }
        
        function isHoliday(date) {
            return holidays.some(h => date >= h.start && date <= h.end);
        }
        
        function formatDate(date) {
            return `${date.getDate()}/${date.getMonth() + 1}`;
        }
        
        function buildTable() {
            shifts = {};
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Header row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>שם העובד</th>';
            
            const dates = [];
            let current = new Date(startDate);
            while (current <= endDate) {
                dates.push(new Date(current));
                const th = document.createElement('th');
                th.innerHTML = `<div class="date-header">${formatDate(current)}</div>`;
                if (isHoliday(current)) {
                    th.style.backgroundColor = '#fff59d';
                }
                headerRow.appendChild(th);
                current.setDate(current.getDate() + 1);
            }
            headerRow.innerHTML += '<th>סה"כ</th>';
            thead.appendChild(headerRow);
            
            // Employee rows
            employees.forEach((emp, empIdx) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="employee-name">${emp}</td>`;
                
                dates.forEach(date => {
                    const dateKey = formatDate(date);
                    if (!shifts[dateKey]) shifts[dateKey] = {};
                    shifts[dateKey][empIdx] = false;
                    
                    const cell = document.createElement('td');
                    cell.className = 'shift-cell';
                    if (isHoliday(date)) cell.classList.add('holiday');
                    cell.dataset.date = dateKey;
                    cell.dataset.employee = empIdx;
                    cell.onclick = toggleShift;
                    row.appendChild(cell);
                });
                
                row.innerHTML += `<td class="total-cell" id="emp-total-${empIdx}">0</td>`;
                tbody.appendChild(row);
            });
            
            // Daily totals row
            const totalRow = document.createElement('tr');
            totalRow.innerHTML = '<td class="employee-name">סה"כ יומי</td>';
            dates.forEach(date => {
                const dateKey = formatDate(date);
                const td = document.createElement('td');
                td.className = 'daily-total';
                td.id = `day-total-${dateKey}`;
                td.textContent = '0';
                
                if (isHoliday(date)) {
                    td.classList.add('holiday');
                    td.textContent = 'חופש';
                }
                
                totalRow.appendChild(td);
            });
            totalRow.innerHTML += '<td></td>';
            tbody.appendChild(totalRow);
            
            // Update statistics
            document.getElementById('totalDays').textContent = dates.length;
            
            // Count actual work days (excluding holidays)
            let workDays = 0;
            let holidayDays = 0;
            dates.forEach(date => {
                if (isHoliday(date)) {
                    holidayDays++;
                } else {
                    workDays++;
                }
            });
            
            document.getElementById('workDays').textContent = workDays;
            document.getElementById('holidayDays').textContent = holidayDays;
            console.log(`Total days: ${dates.length}, Work days: ${workDays}, Holiday days: ${holidayDays}`);
        }
        }
        
        function toggleShift(e) {
            const date = e.target.dataset.date;
            const emp = e.target.dataset.employee;
            
            // Check if it's a holiday
            const dateParts = getDateParts(date);
            const currentDate = new Date(dateParts.year, dateParts.month - 1, dateParts.day);
            
            if (isHoliday(currentDate)) {
                alert('לא ניתן לשבץ עובדים בימי חופש!');
                return;
            }
            
            shifts[date][emp] = !shifts[date][emp];
            
            if (shifts[date][emp]) {
                e.target.classList.add('checked', 'manual');
                e.target.textContent = '✓';
            } else {
                e.target.classList.remove('checked', 'manual');
                e.target.textContent = '';
            }
            
            updateStats();
        }
        
        function updateStats() {
            let lowDays = 0;
            let highDays = 0;
            let violations = 0;
            
            // Update daily totals
            Object.keys(shifts).forEach(date => {
                const count = Object.values(shifts[date]).filter(Boolean).length;
                const cell = document.getElementById(`day-total-${date}`);
                if (cell) {
                    // Check if it's a holiday
                    const dateParts = getDateParts(date);
                    const currentDate = new Date(dateParts.year, dateParts.month - 1, dateParts.day);
                    
                    if (isHoliday(currentDate)) {
                        cell.textContent = 'חופש';
                        cell.classList.add('holiday');
                        cell.classList.remove('error', 'warning');
                    } else {
                        cell.textContent = count;
                        cell.classList.remove('error', 'warning', 'holiday');
                        
                        // Only count non-holiday days
                        if (count < minWorkers) {
                            cell.classList.add('error');
                            lowDays++;
                        } else if (count > minWorkers) {
                            cell.classList.add('warning');
                            highDays++;
                        }
                    }
                }
            });
            
            // Update employee totals and check violations
            const violationDetails = [];
            employees.forEach((emp, idx) => {
                let total = 0;
                let maxConsecutive = 0;
                let currentConsecutive = 0;
                
                const sortedDates = Object.keys(shifts).sort((a, b) => {
                    const dateA = getDateParts(a);
                    const dateB = getDateParts(b);
                    return new Date(dateA.year, dateA.month - 1, dateA.day) - 
                           new Date(dateB.year, dateB.month - 1, dateB.day);
                });
                
                sortedDates.forEach(date => {
                    // Check if it's a holiday
                    const dateParts = getDateParts(date);
                    const currentDate = new Date(dateParts.year, dateParts.month - 1, dateParts.day);
                    
                    if (isHoliday(currentDate)) {
                        // Don't count holidays in consecutive absences
                        return;
                    }
                    
                    if (shifts[date][idx]) {
                        total++;
                        currentConsecutive = 0;
                    } else {
                        currentConsecutive++;
                        maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
                    }
                });
                
                const cell = document.getElementById(`emp-total-${idx}`);
                if (cell) {
                    cell.textContent = total;
                    cell.classList.remove('error');
                    if (maxConsecutive > maxAbsence) {
                        cell.classList.add('error');
                        violations++;
                        violationDetails.push(`${emp}: ${maxConsecutive} ימי היעדרות רצופים`);
                    }
                }
            });
            
            document.getElementById('lowDays').textContent = lowDays;
            document.getElementById('highDays').textContent = highDays;
            document.getElementById('violations').textContent = violations;
            
            // Show warning if there are violations
            if (violations > 0 && violationDetails.length > 0) {
                console.warn('אזהרה: נמצאו הפרות של מגבלת ההיעדרות!', violationDetails);
            }
        }
        
        function clearAll() {
            if (!confirm('לנקות את כל הנתונים?')) return;
            
            Object.keys(shifts).forEach(date => {
                // Check if it's a holiday
                const dateParts = getDateParts(date);
                const currentDate = new Date(dateParts.year, dateParts.month - 1, dateParts.day);
                
                // Clear all shifts (holidays should already be empty)
                Object.keys(shifts[date]).forEach(emp => {
                    shifts[date][emp] = false;
                });
            });
            
            document.querySelectorAll('.shift-cell').forEach(cell => {
                cell.classList.remove('checked', 'manual');
                cell.textContent = '';
            });
            
            updateStats();
        }
        
        function getDateParts(dateStr) {
            const [day, month] = dateStr.split('/').map(Number);
            
            // Get the year from the date range
            let year = startDate.getFullYear();
            
            // Create a test date to check if it's in the range
            let testDate = new Date(year, month - 1, day);
            
            // If the test date is before start date, it might be in the next year
            if (testDate < startDate) {
                year = endDate.getFullYear();
            }
            
            return { day, month, year };
        }
        
        function smartFill() {
            console.log('Starting Smart Fill...');
            
            // Get sorted dates properly
            const dates = Object.keys(shifts).sort((a, b) => {
                const dateA = getDateParts(a);
                const dateB = getDateParts(b);
                return new Date(dateA.year, dateA.month - 1, dateA.day) - 
                       new Date(dateB.year, dateB.month - 1, dateB.day);
            });
            
            const absences = new Array(employees.length).fill(0);
            
            dates.forEach((date, dateIdx) => {
                // Check if it's a holiday
                const dateParts = getDateParts(date);
                const currentDate = new Date(dateParts.year, dateParts.month - 1, dateParts.day);
                
                if (isHoliday(currentDate)) {
                    console.log(`Skipping holiday: ${date}`);
                    // Don't count holidays as absence days
                    return;
                }
                
                // First, count current workers and identify who MUST work today
                const mustWork = [];
                const canWork = [];
                let currentWorkers = 0;
                
                employees.forEach((emp, idx) => {
                    if (shifts[date][idx]) {
                        currentWorkers++;
                        absences[idx] = 0; // Reset absence counter for working employees
                    } else if (absences[idx] >= maxAbsence) {
                        // This employee MUST work today (already absent for max days)
                        mustWork.push(idx);
                    } else {
                        // This employee CAN work today
                        canWork.push(idx);
                    }
                });
                
                if (mustWork.length > 0) {
                    console.log(`Date ${date}: ${mustWork.length} employees MUST work (reached ${maxAbsence} days absence)`);
                }
                
                // Assign all employees who MUST work
                mustWork.forEach(empIdx => {
                    shifts[date][empIdx] = true;
                    absences[empIdx] = 0;
                    currentWorkers++;
                    
                    const cell = document.querySelector(`[data-date="${date}"][data-employee="${empIdx}"]`);
                    if (cell) {
                        cell.classList.add('checked');
                        cell.classList.remove('manual');
                        cell.textContent = '✓';
                    }
                });
                
                // Calculate how many more workers we need
                const needed = Math.max(0, minWorkers - currentWorkers);
                
                if (needed > 0 && canWork.length > 0) {
                    // Sort available workers by absence count (prioritize those with more absences)
                    canWork.sort((a, b) => absences[b] - absences[a]);
                    
                    // Assign needed workers
                    for (let i = 0; i < Math.min(needed, canWork.length); i++) {
                        const empIdx = canWork[i];
                        shifts[date][empIdx] = true;
                        absences[empIdx] = 0;
                        
                        const cell = document.querySelector(`[data-date="${date}"][data-employee="${empIdx}"]`);
                        if (cell) {
                            cell.classList.add('checked');
                            cell.classList.remove('manual');
                            cell.textContent = '✓';
                        }
                    }
                }
                
                // Update absence counters for all non-working employees
                employees.forEach((emp, idx) => {
                    if (!shifts[date][idx]) {
                        absences[idx]++;
                    }
                });
            });
            
            updateStats();
            console.log('Smart Fill completed!');
            
            // Validate the result
            setTimeout(() => {
                const violationCount = parseInt(document.getElementById('violations').textContent);
                if (violationCount > 0) {
                    alert('⚠️ לא הצלחתי למנוע את כל ההיעדרויות הארוכות.\nנסה להוסיף שיבוצים ידניים או להפעיל שוב.');
                }
            }, 100);
        }
        
        function randomFill() {
            if (!confirm('זה ימחק את כל השיבוצים הקיימים. להמשיך?')) return;
            
            console.log('Starting Random Fill...');
            
            // Clear all shifts
            Object.keys(shifts).forEach(date => {
                Object.keys(shifts[date]).forEach(emp => {
                    shifts[date][emp] = false;
                });
            });
            
            document.querySelectorAll('.shift-cell').forEach(cell => {
                cell.classList.remove('checked', 'manual');
                cell.textContent = '';
            });
            
            // Get sorted dates properly
            const dates = Object.keys(shifts).sort((a, b) => {
                const dateA = getDateParts(a);
                const dateB = getDateParts(b);
                return new Date(dateA.year, dateA.month - 1, dateA.day) - 
                       new Date(dateB.year, dateB.month - 1, dateB.day);
            });
            
            const absences = new Array(employees.length).fill(0);
            const workDays = new Array(employees.length).fill(0);
            
            dates.forEach((date, dateIdx) => {
                // Check if it's a holiday
                const dateParts = getDateParts(date);
                const currentDate = new Date(dateParts.year, dateParts.month - 1, dateParts.day);
                
                if (isHoliday(currentDate)) {
                    console.log(`Skipping holiday: ${date}`);
                    // Don't count holidays as absence days
                    return;
                }
                
                // Target 6-10 workers per day
                const target = minWorkers + Math.floor(Math.random() * 5);
                
                // Identify who MUST work (reached max absence)
                const mustWork = [];
                const canWork = [];
                
                employees.forEach((emp, idx) => {
                    if (absences[idx] >= maxAbsence) {
                        mustWork.push(idx);
                    } else {
                        canWork.push(idx);
                    }
                });
                
                if (mustWork.length > 0) {
                    console.log(`Date ${date}: ${mustWork.length} employees MUST work (reached ${maxAbsence} days absence)`);
                }
                
                // First assign all who MUST work
                mustWork.forEach(idx => {
                    shifts[date][idx] = true;
                    absences[idx] = 0;
                    workDays[idx]++;
                });
                
                // Calculate remaining slots
                const assigned = mustWork.length;
                const remaining = Math.max(0, target - assigned);
                
                // Randomly select from those who CAN work
                // But prioritize based on work balance
                canWork.sort((a, b) => {
                    // First priority: fewer work days
                    const daysDiff = workDays[a] - workDays[b];
                    if (daysDiff !== 0) return daysDiff;
                    // Second priority: more consecutive absences (but still under limit)
                    return absences[b] - absences[a];
                });
                
                // Add some randomness while maintaining balance
                for (let i = 0; i < canWork.length; i += 3) {
                    const end = Math.min(i + 3, canWork.length);
                    const slice = canWork.slice(i, end);
                    slice.sort(() => Math.random() - 0.5);
                    canWork.splice(i, 3, ...slice);
                }
                
                // Assign remaining workers
                for (let i = 0; i < Math.min(remaining, canWork.length); i++) {
                    const idx = canWork[i];
                    shifts[date][idx] = true;
                    absences[idx] = 0;
                    workDays[idx]++;
                }
                
                // Update absence counters for non-working employees
                employees.forEach((emp, idx) => {
                    if (!shifts[date][idx]) {
                        absences[idx]++;
                    }
                    
                    // Update UI
                    const cell = document.querySelector(`[data-date="${date}"][data-employee="${idx}"]`);
                    if (cell && shifts[date][idx]) {
                        cell.classList.add('checked');
                        cell.textContent = '✓';
                    }
                });
            });
            
            updateStats();
            console.log('Random Fill completed!');
            
            // Validate the result
            setTimeout(() => {
                const violationCount = parseInt(document.getElementById('violations').textContent);
                if (violationCount > 0) {
                    alert('⚠️ לא הצלחתי למנוע את כל ההיעדרויות הארוכות.\nנסה להפעיל שוב או לשנות את הפרמטרים.');
                }
            }, 100);
        }
        
        function searchByName() {
            const search = document.getElementById('searchName').value.toLowerCase();
            clearHighlights();
            
            if (search) {
                employees.forEach((emp, idx) => {
                    if (emp.toLowerCase().includes(search)) {
                        document.querySelectorAll(`[data-employee="${idx}"]`).forEach(cell => {
                            cell.classList.add('highlight');
                        });
                    }
                });
            }
        }
        
        function searchByDate() {
            const searchDate = document.getElementById('searchDate').value;
            clearHighlights();
            
            if (searchDate) {
                const date = new Date(searchDate);
                const dateKey = formatDate(date);
                document.querySelectorAll(`[data-date="${dateKey}"]`).forEach(cell => {
                    cell.classList.add('highlight');
                });
            }
        }
        
        function clearSearch() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchDate').value = '';
            clearHighlights();
        }
        
        function clearHighlights() {
            document.querySelectorAll('.highlight').forEach(cell => {
                cell.classList.remove('highlight');
            });
        }
        
        function updateDates() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            if (start && end) {
                startDate = new Date(start);
                endDate = new Date(end);
                buildTable();
                updateStats();
            }
        }
        
        function addEmployee() {
            const name = document.getElementById('newEmployee').value.trim();
            if (name && !employees.includes(name)) {
                employees.push(name);
                document.getElementById('newEmployee').value = '';
                buildTable();
                updateStats();
                alert(`${name} נוסף בהצלחה!`);
            }
        }
        
        function exportCSV() {
            let csv = '\ufeff';
            csv += 'שם,';
            
            // Get sorted dates properly
            const dates = Object.keys(shifts).sort((a, b) => {
                const dateA = getDateParts(a);
                const dateB = getDateParts(b);
                return new Date(dateA.year, dateA.month - 1, dateA.day) - 
                       new Date(dateB.year, dateB.month - 1, dateB.day);
            });
            
            csv += dates.join(',') + ',סה"כ\n';
            
            employees.forEach((emp, idx) => {
                let row = [emp];
                let total = 0;
                
                dates.forEach(date => {
                    if (shifts[date][idx]) {
                        row.push('✓');
                        total++;
                    } else {
                        row.push('');
                    }
                });
                
                row.push(total);
                csv += row.join(',') + '\n';
            });
            
            // Add daily totals
            let totalsRow = ['סה"כ יומי'];
            dates.forEach(date => {
                const count = Object.values(shifts[date]).filter(Boolean).length;
                totalsRow.push(count);
            });
            csv += totalsRow.join(',') + '\n';
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'לוח_משמרות.csv';
            link.click();
        }
        
        function validateSchedule() {
            let issues = [];
            
            // Check daily minimums
            const sortedDates = Object.keys(shifts).sort((a, b) => {
                const dateA = getDateParts(a);
                const dateB = getDateParts(b);
                return new Date(dateA.year, dateA.month - 1, dateA.day) - 
                       new Date(dateB.year, dateB.month - 1, dateB.day);
            });
            
            sortedDates.forEach(date => {
                // Check if it's a holiday
                const dateParts = getDateParts(date);
                const currentDate = new Date(dateParts.year, dateParts.month - 1, dateParts.day);
                
                if (!isHoliday(currentDate)) {
                    const count = Object.values(shifts[date]).filter(Boolean).length;
                    if (count < minWorkers) {
                        issues.push(`${date}: רק ${count} עובדים (צריך לפחות ${minWorkers})`);
                    }
                }
            });
            
            // Check consecutive absences (excluding holidays)
            employees.forEach((emp, idx) => {
                let maxConsecutive = 0;
                let currentConsecutive = 0;
                let absenceStart = null;
                
                sortedDates.forEach((date, dateIdx) => {
                    // Check if it's a holiday
                    const dateParts = getDateParts(date);
                    const currentDate = new Date(dateParts.year, dateParts.month - 1, dateParts.day);
                    
                    if (isHoliday(currentDate)) {
                        // Skip holidays
                        return;
                    }
                    
                    if (!shifts[date][idx]) {
                        if (currentConsecutive === 0) {
                            absenceStart = date;
                        }
                        currentConsecutive++;
                        if (currentConsecutive > maxConsecutive) {
                            maxConsecutive = currentConsecutive;
                        }
                    } else {
                        currentConsecutive = 0;
                        absenceStart = null;
                    }
                });
                
                if (maxConsecutive > maxAbsence) {
                    issues.push(`${emp}: נעדר ${maxConsecutive} ימים רצופים (מותר עד ${maxAbsence})`);
                }
            });
            
            // Show results
            if (issues.length === 0) {
                alert('✅ הלוח תקין! כל הדרישות מתקיימות.');
            } else {
                alert('⚠️ נמצאו בעיות בלוח:\n\n' + issues.join('\n'));
            }
        }
        
        function showHelp() {
            alert(`הוראות שימוש:
            
1. לחיצה על תא משבצת/מבטלת עובד
2. השלם חכם - משלים רק את החסר
3. שיבוץ רנדומלי - מתחיל מחדש
4. בדוק תקינות - בודק שכל האילוצים מתקיימים
5. חיפוש לפי שם או תאריך
6. ייצוא ל-CSV לפתיחה באקסל

דרישות:
- מינימום 6 עובדים ביום (לא כולל ימי חופש)
- מקסימום 6 ימי היעדרות רצופים (לא כולל ימי חופש)
- ימי חופש מסומנים בצהוב - אף אחד לא עובד בהם

תקופות חופש נוכחיות:
- 4/8 עד 16/8
- 1/9 עד 13/9

טיפ: המערכת עובדת טוב יותר כשיש עודף עובדים.
אם יש בדיוק 6 עובדים ל-6 ימים, כולם חייבים לעבוד כל יום!`);
        }
        
        function updateHolidaysList() {
            const list = document.getElementById('holidaysList');
            list.innerHTML = '';
            
            if (holidays.length === 0) {
                list.innerHTML = '<p>אין תקופות חופש מוגדרות</p>';
            } else {
                holidays.forEach((h, idx) => {
                    const start = formatDate(new Date(h.start.getTime() + 24*60*60*1000)); // Add 1 day
                    const end = formatDate(new Date(h.end.getTime() - 24*60*60*1000)); // Subtract 1 day
                    const p = document.createElement('p');
                    p.textContent = `${start} - ${end}`;
                    list.appendChild(p);
                });
            }
        }
        
        function addHolidayPeriod() {
            const startInput = document.getElementById('holidayStart').value;
            const endInput = document.getElementById('holidayEnd').value;
            
            if (startInput && endInput) {
                const start = new Date(startInput);
                const end = new Date(endInput);
                
                if (start >= end) {
                    alert('תאריך הסיום חייב להיות אחרי תאריך ההתחלה!');
                    return;
                }
                
                // Adjust dates to exclude boundaries
                const adjustedStart = new Date(start.getTime() - 24*60*60*1000); // Day before
                const adjustedEnd = new Date(end.getTime() + 24*60*60*1000); // Day after
                
                holidays.push({ start: adjustedStart, end: adjustedEnd });
                
                // Clear existing shifts in holiday period
                Object.keys(shifts).forEach(date => {
                    const dateParts = getDateParts(date);
                    const currentDate = new Date(dateParts.year, dateParts.month - 1, dateParts.day);
                    
                    if (currentDate > adjustedStart && currentDate < adjustedEnd) {
                        Object.keys(shifts[date]).forEach(emp => {
                            shifts[date][emp] = false;
                        });
                    }
                });
                
                updateHolidaysList();
                buildTable();
                updateStats();
                
                alert(`תקופת חופש נוספה: ${formatDate(start)} - ${formatDate(end)}`);
                
                // Clear inputs
                document.getElementById('holidayStart').value = '';
                document.getElementById('holidayEnd').value = '';
            } else {
                alert('אנא בחר תאריכי התחלה וסיום לתקופת החופש');
            }
        }
        
        function clearHolidays() {
            if (confirm('למחוק את כל תקופות החופש?')) {
                holidays = [];
                updateHolidaysList();
                buildTable();
                updateStats();
                alert('כל תקופות החופש נמחקו');
            }
        }
        
        function removeEmployee() {
            const select = document.getElementById('removeEmployee');
            const idx = parseInt(select.value);
            
            if (!isNaN(idx) && idx >= 0 && idx < employees.length) {
                const name = employees[idx];
                if (confirm(`למחוק את ${name}?`)) {
                    employees.splice(idx, 1);
                    buildTable();
                    updateStats();
                    alert(`${name} הוסר בהצלחה!`);
                }
            }
        }
        
        function updateMinWorkers() {
            minWorkers = parseInt(document.getElementById('minWorkers').value) || 6;
            updateStats();
        }
        
        function updateMaxAbsence() {
            maxAbsence = parseInt(document.getElementById('maxAbsence').value) || 6;
            updateStats();
        }
        
        // Start
        window.onload = init;
    </script>
</body>
</html>